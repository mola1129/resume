---
import ProfileSidebar from "@/components/ProfileSidebar.vue";
import ProjectExperience from "@/components/ProjectExperience.vue";
import SkillsSection from "@/components/SkillsSection.vue";
import { careerSummary, profile, projects, skills } from "@/data/contents";
import rehypeExternalLinks from "rehype-external-links";
import rehypeStringify from "rehype-stringify";
import { remark } from "remark";
import remarkRehype from "remark-rehype";
import Layout from "../layouts/Layout.astro";

// Markdownをレンダリング
const processMarkdown = async (text: string) => {
  const result = await remark()
    .use(remarkRehype)
    .use(rehypeExternalLinks, {
      target: "_blank",
      rel: ["noopener", "noreferrer"],
    })
    .use(rehypeStringify)
    .process(text);
  return result.toString();
};

const summaryHtml = await processMarkdown(careerSummary);

// プロジェクトのMarkdown処理
const projectsWithHtml = await Promise.all(
  projects.map(async (project) => ({
    ...project,
    descriptionHtml: await processMarkdown(project.description),
    achievementsHtml: project.achievements
      ? await Promise.all(project.achievements.map(processMarkdown))
      : undefined,
  })),
);
---

<Layout>
  <main class="min-h-screen bg-white px-4 py-12 md:px-8 dark:bg-slate-950">
    <div class="mx-auto max-w-5xl">
      <div class="grid grid-cols-1 gap-8 md:grid-cols-[280px_1fr]">
        <!-- 左カラム: サイドバー -->
        <aside>
          <ProfileSidebar
            client:load
            profile={profile}
            profileImageSrc="/profile.png"
          />
        </aside>

        <!-- 右カラム: メインコンテンツ -->
        <main class="space-y-10">
          <!-- Career Summary -->
          <section>
            <h2
              class="mb-4 border-b-2 border-slate-900 pb-2 text-xl font-bold text-slate-900 md:text-2xl dark:border-slate-100 dark:text-slate-50"
            >
              [WIP] 経歴概要
            </h2>
            <div
              class="summary-content text-base leading-relaxed text-slate-700 dark:text-slate-300"
              set:html={summaryHtml.toString()}
            />
          </section>

          <!-- Project Experience -->
          <section>
            <ProjectExperience client:load projects={projectsWithHtml} />
          </section>

          <!-- Skills -->
          <section>
            <SkillsSection client:load categories={skills} />
          </section>
        </main>
      </div>
    </div>
  </main>
</Layout>
