name: visual-regression-test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Build site
        run: pnpm build

      - name: Check if snapshots exist
        id: check-snapshots
        run: |
          if [ -d "tests/visual-regression.spec.ts-snapshots" ] && [ "$(ls -A tests/visual-regression.spec.ts-snapshots/*.png 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Snapshots already exist, will run normal tests"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No snapshots found, will generate them"
          fi

      - name: Run visual regression tests
        run: |
          if [ "${{ steps.check-snapshots.outputs.exists }}" = "false" ]; then
            pnpm test:update
          else
            pnpm test
          fi

      - name: Commit snapshots if new
        if: steps.check-snapshots.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tests/visual-regression.spec.ts-snapshots/

          if ! git diff --staged --quiet; then
            git commit -m "Add visual regression baseline snapshots [skip ci]"
            git push
            echo "Baseline snapshots committed and pushed"
          fi

      - name: Upload snapshots
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: visual-snapshots
          path: tests/visual-regression.spec.ts-snapshots/
          retention-days: 30

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results
          path: test-results/
          retention-days: 30
